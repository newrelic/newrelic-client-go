name: Tutone Generate
on:
  # push:
  #   branches:
  #     - 'feat/automated-codegen'
  workflow_dispatch:
    inputs:
      apiEndpoints:
        required: true
        type: string
        description: 'The API endpoints for which to generate code'
  workflow_call:
    inputs:
      apiEndpoints:
        required: true
        type: string
        description: 'The API endpoints for which to generate code'

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.21.x

      - name: Add GOBIN to PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
        shell: bash

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up git user
        run: |
          git config --global user.name nr-developer-toolkit
          git config --global user.email nr-developer-toolkit@users.noreply.github.com

      - name: Install Tutone
        run: go install github.com/newrelic/tutone/cmd/tutone@latest

      # Append configuration to the config file OR write temporary Tutone config file

      # - name: Write config file
      #   uses: DamianReeves/write-file-action@master
      #   with:
      #     path: .tutone.tmp.yml
      #     contents: |
      #       log_level: debug
      #       cache:
      #         schema_file: schema.json
      #       endpoint: https://api.newrelic.com/graphql
      #       auth:
      #         header: Api-Key
      #         api_key_env_var: NEW_RELIC_API_KEY

      #       packages:
      #         - name: ${{ 'createPackageNameDynamically' }}
      #           path: pkg/${{ 'createPackageNameDynamically' }}
      #           import_path: github.com/newrelic/newrelic-client-go/v2/pkg/${{ 'createPackageNameDynamically' }}
      #           generators:
      #             - typegen
      #             - nerdgraphclient
      #           imports:
      #             - github.com/newrelic/newrelic-client-go/v2/pkg/common
      #             - github.com/newrelic/newrelic-client-go/v2/pkg/nrtime
      #           mutations:
      #             - name: accountManagementCreateAccount
      #               max_query_field_depth: ${{ 'calculatedInDiffReporter' }}
      #             - name: accountManagementUpdateAccount
      #               max_query_field_depth: ${{ 'calculatedInDiffReporter' }}
      #             - name: accountManagementCancelAccount
      #               max_query_field_depth: ${{ 'calculatedInDiffReporter' }}
      #                 write-mode: overwrite

      - name: Check config file contents
        run: cat .tutone.yml
        shell: bash

      # - name: Generate new code
      #   run: tutone generate -c .tutone.tmp.yml
      #   env:
      #     NEW_RELIC_API_KEY: ${{ secrets.NEW_RELIC_API_KEY }}

      # - name: Create Pull Request
      #   uses: peter-evans/create-pull-request@v3
      #   with:
      #     token: ${{ secrets.DEV_TOOLKIT_TOKEN }}
      #     commit-message: 'chore(tutone): update generated code'
      #     signoff: false
      #     branch: feat/generated-code
      #     title: 'feat(codegen): generate code based on latest API changes'
      #     body: |
      #       Update generated code using Tutone
      #     labels: |
      #       enhancement
      #     draft: true
